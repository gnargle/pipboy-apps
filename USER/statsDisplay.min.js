const entryListDisplayMax=6,configListDisplayMax=18,configColumnDisplayMax=9,titleOffsetY=22,perkImageXMaxSize=167,perkImageYMaxSize=153,colourBlack=0,colourGray1=1,colourGray2=2,colourWhite=3,maxScreen=2,perkScreen=2,statScreen=1,SPECIALScreen=0,perkSelectionScreen=3,enabledPerkFolder="USER/StatsDisplay/PERKS/ENABLED/",allPerkFolder="USER/StatsDisplay/PERKS/ALL/",skillsFolder="USER/StatsDisplay/SKILLS/",specialFolder="USER/StatsDisplay/SPECIAL/";let isModernVersion=!1;try{let r=require("Storage"),e=r.list();if(e.includes("VERSION")&&e.includes(".bootcde")){let e=r.read("VERSION")||"",n=parseFloat(e);isModernVersion=1.29<=n}}catch(e){console.log("Unable to determine JS version:",e)}function normalizeDir(e){return isModernVersion&&e.endsWith("/")?e.slice(0,-1):isModernVersion||e.endsWith("/")?e:e+"/"}function draw(){drawing||(drawing=!0,bC.clear(),screenSelected==perkScreen?buildScreen(enabledPerkFolder):screenSelected==statScreen?buildScreen(skillsFolder):screenSelected==SPECIALScreen?buildScreen(specialFolder):screenSelected==perkSelectionScreen&&buildPerkSelectionScreen(),bH.flip(),bF.flip(),bC.flip(),drawing=!1)}function buildScreen(l){if(null==lastReload){var t;displayedPerks=[];try{t=fs.readdirSync(normalizeDir(l))}catch{fs.mkdir(normalizeDir(l)),t=fs.readdirSync(normalizeDir(l))}if(t=t.filter(e=>"."!==e&&".."!==e),isModernVersion&&(t=t.filter(n=>{try{return!fs.statSync(normalizeDir(l)+"/"+n).isDirectory}catch(e){return console.log("Skipping bad file or folder:",n),!1}})),loadedListMax=t.length,0==t.length)return void drawEmptyScreen();let e=Math.min(entryListDisplayMax,loadedListMax),n=0;for(;entrySelected>=e;)n++,e=Math.min(entryListDisplayMax*(n+1),loadedListMax);for(let r=n*entryListDisplayMax;r<e;r++){var i=t[r],o=normalizeDir(l)+"/"+i;let e;try{e=fs.readFileSync(o)}catch(e){console.log("Skipping unreadable file:",o,e);continue}let n;try{n=JSON.parse(e)}catch(e){console.log("Invalid JSON in file:",o);continue}screenSelected!=perkScreen?displayedPerks.push({title:n.title,filename:i,entryNum:r,points:n.points}):displayedPerks.push({title:n.title,filename:i,entryNum:r})}lastReload=entrySelected}if(null==currentPerk){var n=entrySelected%6,n=displayedPerks[n].filename,n=normalizeDir(l)+"/"+n;try{var e=fs.readFileSync(n);currentPerk=JSON.parse(e)}catch(e){console.log("Error loading currentPerk file:",n,e),currentPerk=null}}for(let e=0;e<displayedPerks.length;e++){var r=displayedPerks[e];r.entryNum==entrySelected&&(drawEntry(currentPerk),drawSelectedEntryOutline(e),configMode||screenSelected==perkScreen||(pointsOfSelected=r.points)),drawEntryTitle(r.title,e,r.entryNum==entrySelected),screenSelected!=perkScreen&&drawEntryPoints(r.points,e,r.entryNum==entrySelected)}}function buildPerkSelectionScreen(){0==allPerks.length&&generatePerksConfigLists();let e=Math.min(configListDisplayMax,loadedListMax),n=0;for(;entrySelected>=e;)n++,e=Math.min(configListDisplayMax*(n+1),loadedListMax);let r=0;for(i=n*configListDisplayMax;i<e;i++){i!=n*configListDisplayMax&&i%configColumnDisplayMax==0&&(r=1);var l=allPerks[i];i==entrySelected&&drawSelectedEntryOutlineConfig(i%configListDisplayMax,r),drawEntryTitleConfig(l.title,i%configListDisplayMax,i==entrySelected,r,enabledPerks.includes(l.filename))}}function generatePerksConfigLists(){var e,n,r;try{e=fs.readdirSync(normalizeDir(enabledPerkFolder))}catch{fs.mkdir(enabledPerkFolder),e=fs.readdirSync(normalizeDir(enabledPerkFolder))}for(n of e=e.filter(e=>"."!==e&&".."!==e))enabledPerks.push(n);try{e=(e=fs.readdirSync(normalizeDir(allPerkFolder))).filter(e=>"."!==e&&".."!==e)}catch{console.log("ERROR: Missing ALL perk folder!"),e=[]}loadedListMax=e.length;for(r of e){var l=normalizeDir(allPerkFolder)+"/"+r;let e;try{e=fs.readFileSync(l)}catch(e){console.log("Skipping missing perk file:",l,e);continue}let n;try{n=JSON.parse(e)}catch(e){console.log("Skipping invalid JSON perk file:",l,e);continue}l={filename:r,title:n.title};allPerks.push(l)}}function drawEmptyScreen(){bC.setFontMonofonto18(),bC.setColor(colourWhite),bC.drawString("No Perks selected, press wheel to configure.",2,100)}function drawEntry(e){drawEntryImage(e.img,e.xSize,e.ySize),drawEntryDesc(e.description)}function drawEntryImage(e,n,r){var l=Math.floor((perkImageXMaxSize-n)/2),t=Math.floor((perkImageYMaxSize-r)/2);bC.setColor(colourGray2),bC.drawImage({width:n,height:r,bpp:1,buffer:require("heatshrink").decompress(atob(e))},200+l,0+t)}function drawEntryTitle(e,n,r){bC.setFontMonofonto18(),r?bC.setColor(colourBlack):bC.setColor(colourWhite),bC.drawString(e,10,titleOffsetY*n+5)}function drawEntryTitleConfig(e,n,r,l,t){bC.setFontMonofonto18();let i="";i=t?e+" *":e,r?bC.setColor(colourBlack):bC.setColor(colourWhite),0==l?bC.drawString(i,10,titleOffsetY*n+5):bC.drawString(i,210,titleOffsetY*(n-configColumnDisplayMax)+5)}function drawEntryPoints(e,n,r){bC.setFontMonofonto18(),r?bC.setColor(colourBlack):bC.setColor(colourWhite),configMode&&r?(bC.fillPoly([129,titleOffsetY*n+12,140,titleOffsetY*n+12,135,titleOffsetY*n+5]),bC.fillPoly([141,titleOffsetY*n+12,151,titleOffsetY*n+12,146,titleOffsetY*n+17]),bC.drawString(pointsOfSelected,160,titleOffsetY*n+5)):bC.drawString(e,160,titleOffsetY*n+5)}function drawEntryDesc(e){bC.setFontMonofonto14(),bC.setColor(colourWhite),bC.drawString(e,10,150)}function drawSelectedEntryOutline(e){bC.setColor(colourWhite),bC.fillRect(5,titleOffsetY*e+1,190,titleOffsetY*e+23)}function drawSelectedEntryOutlineConfig(e,n){bC.setColor(colourWhite),0==n?bC.fillRect(5,titleOffsetY*e+1,190,titleOffsetY*e+23):bC.fillRect(205,titleOffsetY*(e-configColumnDisplayMax)+1,390,titleOffsetY*(e-configColumnDisplayMax)+23)}function saveFile(r){if(entrySelected%entryListDisplayMax>=displayedPerks.length)console.log("Invalid entrySelected index");else{var l=displayedPerks[entrySelected%entryListDisplayMax].filename,r=normalizeDir(r)+"/"+l;let e;try{e=fs.readFileSync(r)}catch(e){return void console.log("Error reading file to save:",r,e)}let n;try{n=JSON.parse(e)}catch(e){return void console.log("Error parsing JSON in file to save:",r,e)}n.points=pointsOfSelected,e=JSON.stringify(n);try{fs.writeFile(r,e)}catch(e){console.log("Error writing file:",r,e)}displayedPerks[entrySelected%entryListDisplayMax].points=pointsOfSelected,currentPerk=n}}function saveNewValue(){screenSelected==SPECIALScreen?saveFile(specialFolder):screenSelected==statScreen&&saveFile(skillsFolder)}function saveEnabledPerk(e){var n=fs.readFileSync(normalizeDir(allPerkFolder)+"/"+e);fs.writeFile(normalizeDir(enabledPerkFolder)+"/"+e,n)}function saveNewPerkSelection(){let n;try{n=fs.readdirSync(normalizeDir(enabledPerkFolder))}catch(e){console.log("Enabled folder missing, creating..."),fs.mkdir(normalizeDir(enabledPerkFolder)),n=[]}n=n.filter(e=>"."!==e&&".."!==e);for(let e=0;e<allPerks.length;e++){var r=allPerks[e];enabledPerks.includes(r.filename)&&n.includes(r.filename)||(enabledPerks.includes(r.filename)&&!n.includes(r.filename)?saveEnabledPerk(r.filename):!enabledPerks.includes(r.filename)&&n.includes(r.filename)&&fs.unlink(normalizeDir(enabledPerkFolder)+"/"+r.filename))}enabledPerks=[],allPerks=[]}function togglePerkEnabled(){var e,n=allPerks[entrySelected];enabledPerks.includes(n.filename)?(e=enabledPerks.indexOf(n.filename),enabledPerks.splice(e,1)):enabledPerks.push(n.filename)}function handleKnob1Config(e){Pip.knob1Click(e),0==e?(configMode=!configMode,saveNewValue(),Pip.removeListener("knob1",handleKnob1Config),Pip.on("knob1",handleKnob1),registeredKnob1Func=handleKnob1):(pointsOfSelected+=e)<0?pointsOfSelected=100:100<pointsOfSelected&&(entrySelected=0)}function handleKnob1(e){Pip.knob1Click(e),0==e?screenSelected==perkScreen?(entrySelected=0,screenSelected=perkSelectionScreen,currentPerk=null):screenSelected==perkSelectionScreen?togglePerkEnabled():(configMode=!configMode,Pip.removeListener("knob1",handleKnob1),Pip.on("knob1",handleKnob1Config),registeredKnob1Func=handleKnob1Config):(entrySelected-=e,currentPerk=null,entrySelected<0?(entrySelected=loadedListMax-1,loadedListMax>entryListDisplayMax&&(lastReload=null)):entrySelected>=loadedListMax&&(entrySelected=0),(0<e&&lastReload-1==entrySelected||entrySelected%entryListDisplayMax==0&&entrySelected!=lastReload)&&(lastReload=null))}function handleKnob2(e){Pip.knob2Click(e),configMode=!1,screenSelected==perkSelectionScreen?(saveNewPerkSelection(),screenSelected=perkScreen):screenSelected+=e,entrySelected=0,currentPerk=null,lastReload=null,screenSelected>maxScreen?screenSelected=0:screenSelected<0&&(screenSelected=maxScreen)}function handleTorch(){gracefulClose(),torchButtonHandler()}function powerHandler(){gracefulClose()}function gracefulClose(){clearInterval(intervalId),Pip.removeListener("knob1",registeredKnob1Func),Pip.removeListener("knob2",handleKnob2),Pip.removeListener("torch",handleTorch),E.reboot()}Graphics.prototype.setFontMonofonto14=function(){return this.setFontCustom(E.toString(require("heatshrink").decompress(atob("AB0D/uP/0/7AICh+AnwNC8AGBAoMBwFnw4UB/H/8f/h4ZDgHxw/nn/e+/55/DEIV88P/w/4g/4v/j7+MvwNBu4iBx/2FIPz8EfwEyKAwjB/BZGgH/5///kPLQcD///n/whgIBAQMzgARB+E/wE/gHMMwUAgkAiEBJgPgAwQyFgPgg+AjAIDsCCBg0ABINgCwoKBnAKDgahBFYN+h/gnkA4BTCUAkBXgX4n4OCgEcgCSBRYP+HQUjweOn0zDYNj+ODG4INB4YNBt0zzDKCwZYCIIN+XQLYEMwkD/cP90/zHO8c/ZQZxBj+DJgOY/1jz+IBoXAkcHxhhDgfgWwUAmODLQU7zHusZhEnED/GP805/Hn8f+g/wWwuYg9wjOABQkZ8F3wOYWIakB+EHsAUB4cDH4UJgEkgGQgVAAwgNBmHAWwIwB8EPEQTUCsEDwOO9033H8kfggY+Cj5xB+f95v7m3s/+x/zVBgPgN4U/+H/AwOAjyuDBof4UAKEEv/DAwUwjHg8eDwUIBoLRCBoM4nDmD/ANGmOY41jSggNFwHGgbyCh5KBBoOOg0z/Hv8e/DYLfCBoOAsAGFFIXALQYNBAwMBBoQtBsEBxkODYZtCIowNB/fjgZTIEQhFGOwJFIDYfwh4NFN4yZEG5E54H/gKlCDYsHnE+//7cIIbHnY3C+YpDvHD+eP80z7Hn8efBoMwTIL7FAwIZCn43DwEGPoJTEng3BwYGBDYQGB4AbBnxFDwf+Po0ghHxAwOH/iZDwZFD/BFBDYINB/jCDmEY4fjn5TCzH4dogADh//AAJXCiEAnApBgH8AIV+QoLhBIoIfBg4ZCLoQMBh+AN4PwgPgGIkEFIVAgIGFBoMCgEMG4QtBDIcwhvgm6SBgfYcIM/ehEDjANF8EH4AGB8wNBh3gmINBgPwCgfGUAauCDYvWgdYCgM9BoLqBhj0F5j0DDYMPY4Ow43D/4GC8BTIWQJhFhljn+O/0zWgJ+BAAMDgcMh8//3/+f/aIY+C/4iC90CjAlDgBoGgf4G4Y+BAwgmDBohMGoCgF3ANBj53DN4Xw//DXgquGSwIUDG43AG4MOeAIpDh1AWoJTCfYMXSQiiBwf+h/4hlgcwUDXgIpCg0AIosDwEPMIU+PoXAnCuCKYUfRYs8BoMChEMEQV+BocgFInENAMfegQpDKYVgm4pEKYYADhB4Bn////+PwqOC/+/BYIVDCYP//h/BkAKBOQUAsEBPIYGBBoI"))),32,atob("BwYHCAgICAYHBggIBgcGCAgGCAgICAgICAgGBggICAgICAgICAcICAgICAgICAgICAgICAgICAgICAgICAUICAcICAgICAgICAcHCAYICAgICAgICAgICAgICAgGBwg="),65550)};let loadedListMax=0,entrySelected=0,screenSelected=0,pointsOfSelected=0,drawing=!1,configMode=!1,allPerks=[],enabledPerks=[],displayedPerks=[],currentPerk=null,lastReload=null,registeredKnob1Func=handleKnob1,intervalId=(Pip.on("knob1",registeredKnob1Func),Pip.on("knob2",handleKnob2),Pip.on("torch",handleTorch),setWatch(powerHandler,BTN_POWER,{repeat:!1}),setInterval(()=>{checkMode(),(2==Pip.mode?draw:gracefulClose)()},16));