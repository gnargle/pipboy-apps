const entryListDisplayMax=6,configListDisplayMax=18,configColumnDisplayMax=9,titleOffsetY=22,perkImageXMaxSize=167,perkImageYMaxSize=153,colourBlack=0,colourGray1=1,colourGray2=2,colourWhite=3,maxScreen=2,perkScreen=2,statScreen=1,SPECIALScreen=0,perkSelectionScreen=3,enabledPerkFolder="USER/StatsDisplay/PERKS/ENABLED/",allPerkFolder="USER/StatsDisplay/PERKS/ALL/",skillsFolder="USER/StatsDisplay/SKILLS/",specialFolder="USER/StatsDisplay/SPECIAL/";
Graphics.prototype.setFontMonofonto14=function(){return this.setFontCustom(E.toString(require("heatshrink").decompress(atob("AB0D/uP/0/7AICh+AnwNC8AGBAoMBwFnw4UB/H/8f/h4ZDgHxw/nn/e+/55/DEIV88P/w/4g/4v/j7+MvwNBu4iBx/2FIPz8EfwEyKAwjB/BZGgH/5///kPLQcD///n/whgIBAQMzgARB+E/wE/gHMMwUAgkAiEBJgPgAwQyFgPgg+AjAIDsCCBg0ABINgCwoKBnAKDgahBFYN+h/gnkA4BTCUAkBXgX4n4OCgEcgCSBRYP+HQUjweOn0zDYNj+ODG4INB4YNBt0zzDKCwZYCIIN+XQLYEMwkD/cP90/zHO8c/ZQZxBj+DJgOY/1jz+IBoXAkcHxhhDgfgWwUAmODLQU7zHusZhEnED/GP805/Hn8f+g/wWwuYg9wjOABQkZ8F3wOYWIakB+EHsAUB4cDH4UJgEkgGQgVAAwgNBmHAWwIwB8EPEQTUCsEDwOO9033H8kfggY+Cj5xB+f95v7m3s/+x/zVBgPgN4U/+H/AwOAjyuDBof4UAKEEv/DAwUwjHg8eDwUIBoLRCBoM4nDmD/ANGmOY41jSggNFwHGgbyCh5KBBoOOg0z/Hv8e/DYLfCBoOAsAGFFIXALQYNBAwMBBoQtBsEBxkODYZtCIowNB/fjgZTIEQhFGOwJFIDYfwh4NFN4yZEG5E54H/gKlCDYsHnE+//7cIIbHnY3C+YpDvHD+eP80z7Hn8efBoMwTIL7FAwIZCn43DwEGPoJTEng3BwYGBDYQGB4AbBnxFDwf+Po0ghHxAwOH/iZDwZFD/BFBDYINB/jCDmEY4fjn5TCzH4dogADh//AAJXCiEAnApBgH8AIV+QoLhBIoIfBg4ZCLoQMBh+AN4PwgPgGIkEFIVAgIGFBoMCgEMG4QtBDIcwhvgm6SBgfYcIM/ehEDjANF8EH4AGB8wNBh3gmINBgPwCgfGUAauCDYvWgdYCgM9BoLqBhj0F5j0DDYMPY4Ow43D/4GC8BTIWQJhFhljn+O/0zWgJ+BAAMDgcMh8//3/+f/aIY+C/4iC90CjAlDgBoGgf4G4Y+BAwgmDBohMGoCgF3ANBj53DN4Xw//DXgquGSwIUDG43AG4MOeAIpDh1AWoJTCfYMXSQiiBwf+h/4hlgcwUDXgIpCg0AIosDwEPMIU+PoXAnCuCKYUfRYs8BoMChEMEQV+BocgFInENAMfegQpDKYVgm4pEKYYADhB4Bn////+PwqOC/+/BYIVDCYP//h/BkAKBOQUAsEBPIYGBBoI"))),32,
atob("BwYHCAgICAYHBggIBgcGCAgGCAgICAgICAgGBggICAgICAgICAcICAgICAgICAgICAgICAgICAgICAgICAUICAcICAgICAgICAcHCAYICAgICAgICAgICAgICAgGBwg="),65550)};function draw(){drawing||(drawing=!0,bC.clear(),screenSelected==perkScreen?buildScreen(enabledPerkFolder):screenSelected==statScreen?buildScreen(skillsFolder):screenSelected==SPECIALScreen?buildScreen(specialFolder):screenSelected==perkSelectionScreen&&buildPerkSelectionScreen(),bH.flip(),bF.flip(),bC.flip(),drawing=!1)}
function buildScreen(a){if(null==lastReload){displayedPerks=[];try{var b=require("fs").readdirSync(a)}catch{require("fs").mkdir(a),b=require("fs").readdirSync(a)}loadedListMax=b.length;if(0==b.length){drawEmptyScreen();return}let e=Math.min(entryListDisplayMax,loadedListMax);for(var c=0;entrySelected>=e;)c++,e=Math.min(entryListDisplayMax*(c+1),loadedListMax);for(i=c*entryListDisplayMax;i<e;i++){c=b[i];var d=require("fs").readFileSync(a+c);d=JSON.parse(d);screenSelected!=perkScreen?displayedPerks.push({title:d.title,
filename:c,entryNum:i,points:d.points}):displayedPerks.push({title:d.title,filename:c,entryNum:i})}lastReload=entrySelected}null==currentPerk&&(b=displayedPerks[entrySelected%6].filename,a=require("fs").readFileSync(a+b),currentPerk=JSON.parse(a));for(a=0;a<displayedPerks.length;a++)b=displayedPerks[a],b.entryNum==entrySelected&&(drawEntry(currentPerk),drawSelectedEntryOutline(a),configMode||screenSelected==perkScreen||(pointsOfSelected=b.points)),drawEntryTitle(b.title,a,b.entryNum==entrySelected),
screenSelected!=perkScreen&&drawEntryPoints(b.points,a,b.entryNum==entrySelected)}
function buildPerkSelectionScreen(){0==allPerks.length&&generatePerksConfigLists();let a=Math.min(configListDisplayMax,loadedListMax),b=0;for(;entrySelected>=a;)b++,a=Math.min(configListDisplayMax*(b+1),loadedListMax);let c=0;for(i=b*configListDisplayMax;i<a;i++){i!=b*configListDisplayMax&&0==i%configColumnDisplayMax&&(c=1);let d=allPerks[i];i==entrySelected&&drawSelectedEntryOutlineConfig(i%configListDisplayMax,c);drawEntryTitleConfig(d.title,i%configListDisplayMax,i==entrySelected,c,enabledPerks.includes(d.filename))}}
function generatePerksConfigLists(){try{var a=require("fs").readdirSync(enabledPerkFolder)}catch{require("fs").mkdir(enabledPerkFolder),a=require("fs").readdirSync(enabledPerkFolder)}for(file of a)enabledPerks.push(file);a=require("fs").readdirSync(allPerkFolder);loadedListMax=a.length;for(file of a)a=require("fs").readFileSync(allPerkFolder+file),a=JSON.parse(a),allPerks.push({filename:file,title:a.title})}
function drawEmptyScreen(){bC.setFontMonofonto18();bC.setColor(colourWhite);bC.drawString("No Perks selected, press wheel to configure.",2,100)}function drawEntry(a){drawEntryImage(a.img,a.xSize,a.ySize);drawEntryDesc(a.description)}function drawEntryImage(a,b,c){let d=Math.floor((perkImageXMaxSize-b)/2),e=Math.floor((perkImageYMaxSize-c)/2);bC.setColor(colourGray2);bC.drawImage({width:b,height:c,bpp:1,buffer:require("heatshrink").decompress(atob(a))},200+d,0+e)}
function drawEntryTitle(a,b,c){bC.setFontMonofonto18();c?bC.setColor(colourBlack):bC.setColor(colourWhite);bC.drawString(a,10,titleOffsetY*b+5)}function drawEntryTitleConfig(a,b,c,d,e){bC.setFontMonofonto18();a=e?a+" *":a;c?bC.setColor(colourBlack):bC.setColor(colourWhite);0==d?bC.drawString(a,10,titleOffsetY*b+5):bC.drawString(a,210,titleOffsetY*(b-configColumnDisplayMax)+5)}
function drawEntryPoints(a,b,c){bC.setFontMonofonto18();c?bC.setColor(colourBlack):bC.setColor(colourWhite);configMode&&c?(bC.fillPoly([129,titleOffsetY*b+12,140,titleOffsetY*b+12,135,titleOffsetY*b+5]),bC.fillPoly([141,titleOffsetY*b+12,151,titleOffsetY*b+12,146,titleOffsetY*b+17]),bC.drawString(pointsOfSelected,160,titleOffsetY*b+5)):bC.drawString(a,160,titleOffsetY*b+5)}function drawEntryDesc(a){bC.setFontMonofonto14();bC.setColor(colourWhite);bC.drawString(a,10,150)}
function drawSelectedEntryOutline(a){bC.setColor(colourWhite);bC.fillRect(5,titleOffsetY*a+1,190,titleOffsetY*a+23)}function drawSelectedEntryOutlineConfig(a,b){bC.setColor(colourWhite);0==b?bC.fillRect(5,titleOffsetY*a+1,190,titleOffsetY*a+23):bC.fillRect(205,titleOffsetY*(a-configColumnDisplayMax)+1,390,titleOffsetY*(a-configColumnDisplayMax)+23)}
function saveFile(a){var b=require("fs").readdirSync(a);a+=b[entrySelected];b=require("fs").readFileSync(a);let c=JSON.parse(b);c.points=pointsOfSelected;b=JSON.stringify(c);require("fs").writeFile(a,b);displayedPerks[entrySelected%entryListDisplayMax].points=pointsOfSelected;currentPerk=c}function saveNewValue(){screenSelected==SPECIALScreen?saveFile(specialFolder):screenSelected==statScreen&&saveFile(skillsFolder)}
function saveEnabledPerk(a){let b=require("fs").readFileSync(allPerkFolder+a);require("fs").writeFile(enabledPerkFolder+a,b)}
function saveNewPerkSelection(){let a=require("fs").readdirSync(enabledPerkFolder);for(let b=0;b<allPerks.length;b++){let c=allPerks[b];enabledPerks.includes(c.filename)&&a.includes(c.filename)||(enabledPerks.includes(c.filename)&&!a.includes(c.filename)?saveEnabledPerk(c.filename):!enabledPerks.includes(c.filename)&&a.includes(c.filename)&&require("fs").unlink(enabledPerkFolder+c.filename))}enabledPerks=[];allPerks=[]}
function togglePerkEnabled(){var a=allPerks[entrySelected];enabledPerks.includes(a.filename)?(a=enabledPerks.indexOf(a.filename),enabledPerks.splice(a,1)):enabledPerks.push(a.filename)}function handleKnob1Config(a){Pip.knob1Click(a);0==a?(configMode=!configMode,saveNewValue(),Pip.removeListener("knob1",handleKnob1Config),Pip.on("knob1",handleKnob1),registeredKnob1Func=handleKnob1):(pointsOfSelected+=a,0>pointsOfSelected?pointsOfSelected=100:100<pointsOfSelected&&(entrySelected=0));draw()}
function handleKnob1(a){Pip.knob1Click(a);0==a?screenSelected==perkScreen?(entrySelected=0,screenSelected=perkSelectionScreen,currentPerk=null):screenSelected==perkSelectionScreen?togglePerkEnabled():(configMode=!configMode,Pip.removeListener("knob1",handleKnob1),Pip.on("knob1",handleKnob1Config),registeredKnob1Func=handleKnob1Config):(entrySelected-=a,currentPerk=null,0>entrySelected?entrySelected=loadedListMax-1:entrySelected>=loadedListMax&&(entrySelected=0),0<a&&lastReload-1==entrySelected?lastReload=
null:0==entrySelected%entryListDisplayMax&&entrySelected!=lastReload&&(lastReload=null));draw()}function handleKnob2(a){Pip.knob2Click(a);configMode=!1;screenSelected==perkSelectionScreen?(saveNewPerkSelection(),screenSelected=perkScreen):screenSelected+=a;entrySelected=0;lastReload=currentPerk=null;screenSelected>maxScreen?screenSelected=0:0>screenSelected&&(screenSelected=maxScreen);draw()}function handleTorch(){gracefulClose();torchButtonHandler()}function powerHandler(){gracefulClose()}
function gracefulClose(){clearInterval(intervalId);Pip.removeListener("knob1",registeredKnob1Func);Pip.removeListener("knob2",handleKnob2);Pip.removeListener("torch",handleTorch);showMainMenu()}let loadedListMax=0,entrySelected=0,screenSelected=0,pointsOfSelected=0,drawing=!1,configMode=!1,allPerks=[],enabledPerks=[],displayedPerks=[],currentPerk=null,lastReload=null,registeredKnob1Func=handleKnob1;Pip.on("knob1",registeredKnob1Func);Pip.on("knob2",handleKnob2);Pip.on("torch",handleTorch);
setWatch(powerHandler,BTN_POWER,{repeat:!1});draw();let intervalId=setInterval(()=>{checkMode();2==Pip.mode?draw():gracefulClose()},16);
